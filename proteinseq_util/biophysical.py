#! /usr/bin/python

# -*- coding: utf-8 -*-
__author__ = "Ehsaneddin Asgari"
__license__ = "Apache 2"
__version__ = "1.0.0"
__maintainer__ = "Ehsaneddin Asgari"
__email__ = "asgari@berkeley.edu"
__project__ = "DIMOTIF 2018"
__website__ = "llp.berkeley.edu/dimotif"


from Bio.SeqUtils.ProtParam import ProteinAnalysis
import numpy as np

class ProtSeqProp(object):
    '''
    Biophysical properties of protein peptides
    The original scores were obtained from biopython implementation and then they are normalized:
    zero-mean and unit-variance
    '''
    # Kyte & Doolittle index of hydrophobicity
    kd = {'A': 0.78657940345646571,
         'C': 1.0270185224169575,
         'D': -1.0338882115301142,
         'E': -1.0338882115301142,
         'F': 1.1300638591143111,
         'G': 0.030913601009206104,
         'H': -0.93084287483276074,
         'I': 1.7139874337326482,
         'K': -1.1712819937932524,
         'L': 1.4735483147721564,
         'M': 0.82092784902225036,
         'N': -1.0338882115301142,
         'P': -0.38126774578020822,
         'Q': -1.0338882115301142,
         'R': -1.3773726671879596,
         'S': -0.10648018125393202,
         'T': -0.072131735688147458,
         'V': 1.6109420970352946,
         'W': -0.14082862681971656,
         'Y': -0.27822240908285467}

    # Flexibility
    # Normalized flexibility parameters (B-values), average (Vihinen et al., 1994)
    Flex = {'A': -0.10447367941301335,
             'C': -1.3298792424529011,
             'D': 1.21519385001456,
             'E': 1.6236623710278566,
             'F': -1.1884862928713755,
             'G': 0.63391172395717477,
             'H': -0.63862482227655493,
             'I': -0.99996236009600781,
             'K': 1.7493449928781015,
             'L': -0.87427973824576277,
             'M': -0.6072041668139937,
             'N': 0.90098729538894728,
             'P': 0.91669762312022618,
             'Q': 0.72817369034485857,
             'R': 0.27257418613772189,
             'S': 0.86956663992638605,
             'T': 0.099760581093634906,
             'V': -0.93712104917088523,
             'W': -1.3612998979154625,
             'Y': -0.96854170463344658}

    # Hydrophilicity
    # 1 Hopp & Wood
    # Proc. Natl. Acad. Sci. U.S.A. 78:3824-3828(1981).
    hw = {'A': -0.15187800657861578,
         'C': -0.41833064969899431,
         'D': 1.7132904952640338,
         'E': 1.7132904952640338,
         'F': -1.2176885790601299,
         'G': 0.11457463654176277,
         'H': -0.15187800657861578,
         'I': -0.84465487869159994,
         'K': 1.7132904952640338,
         'L': -0.84465487869159994,
         'M': -0.57820223557122141,
         'N': 0.2211556937899142,
         'P': 0.11457463654176277,
         'Q': 0.2211556937899142,
         'R': 1.7132904952640338,
         'S': 0.27444622241398986,
         'T': -0.098587477954540065,
         'V': -0.68478329281937278,
         'W': -1.6973033366768113,
         'Y': -1.1111075218119784}

    # Surface accessibility
    # 1 Emini Surface fractional probability
    em = {'A': -0.56528574363423767,
         'C': -1.8022155672829585,
         'D': 0.80973363277336652,
         'E': 1.2857018784529222,
         'F': -0.91785481450798234,
         'G': -0.86203137828630605,
         'H': 0.50711184694006906,
         'I': -1.18815776884452,
         'K': 1.5795094375143759,
         'L': -1.18815776884452,
         'M': -0.86203137828630605,
         'N': 0.84792861545135589,
         'P': 0.67164408001448339,
         'Q': 1.0007085461633121,
         'R': 1.3738441461713584,
         'S': 0.31613693355012418,
         'T': 0.51886414930252722,
         'V': -1.1793435420726763,
         'W': -0.58585227276853913,
         'Y': 0.23974696819414609}

    # 2 Janin Interior to surface transfer energy scale
    ja = {'A': 0.5879433493975047,
         'C': 1.620210298721368,
         'D': -0.6088878961953802,
         'E': -1.3419470341210222,
         'F': 0.85723037965590376,
         'G': 0.81234920794617049,
         'H': -0.29471969422724792,
         'I': 1.0666758476346587,
         'K': -2.2545308588855972,
         'L': 1.0666758476346587,
         'M': 0.81234920794617049,
         'N': -0.65376906790511347,
         'P': -0.45928399049626956,
         'Q': -0.86321453588386821,
         'R': -1.5364321115298658,
         'S': -0.11519500738831519,
         'T': -0.30968008479715903,
         'V': 1.0666758476346587,
         'W': 0.60290373996741575,
         'Y': -0.055353445108670934}

    # A two dimensional dictionary for calculating the instability index.
    # Guruprasad K., Reddy B.V.B., Pandit M.W.    Protein Engineering 4:155-161(1990).
    # It is based on dipeptide values therefore the vale for the dipeptide DG is DIWV['D']['G'].
    DIWV={'A': {'A': -0.28258896805474465,  'C': 3.1862205593510162,  'D': -0.9528254925808008,  'E': -0.28258896805474465,  'F': -0.28258896805474465,  'G': -0.28258896805474465,  'H': -0.9528254925808008,  'I': -0.28258896805474465,  'K': -0.28258896805474465,  'L': -0.28258896805474465,  'M': -0.28258896805474465,  'N': -0.28258896805474465,  'P': 1.2378769285732698,  'Q': -0.28258896805474465,  'R': -0.28258896805474465,  'S': -0.28258896805474465,  'T': -0.28258896805474465,  'V': -0.28258896805474465,  'W': -0.28258896805474465,  'Y': -0.28258896805474465}, 'C': {'A': -0.28258896805474465,  'C': -0.28258896805474465,  'D': 1.2378769285732698,  'E': -0.28258896805474465,  'F': -0.28258896805474465,  'G': -0.28258896805474465,  'H': 2.2909929753550826,  'I': -0.28258896805474465,  'K': -0.28258896805474465,  'L': 1.2378769285732698,  'M': 2.2909929753550826,  'N': -0.28258896805474465,  'P': 1.2378769285732698,  'Q': -0.8778284727575083,  'R': -0.28258896805474465,  'S': -0.28258896805474465,  'T': 2.2909929753550826,  'V': -0.8778284727575083,  'W': 1.5868104313300622,  'Y': -0.28258896805474465}, 'D': {'A': -0.28258896805474465,  'C': -0.28258896805474465,  'D': -0.28258896805474465,  'E': -0.28258896805474465,  'F': -0.8778284727575083,  'G': -0.28258896805474465,  'H': -0.28258896805474465,  'I': -0.28258896805474465,  'K': -0.9528254925808008,  'L': -0.28258896805474465,  'M': -0.28258896805474465,  'N': -0.28258896805474465,  'P': -0.28258896805474465,  'Q': -0.28258896805474465,  'R': -0.8778284727575083,  'S': 1.2378769285732698,  'T': -1.4691207658906251,  'V': -0.28258896805474465,  'W': -0.28258896805474465,  'Y': -0.28258896805474465}, 'E': {'A': -0.28258896805474465,  'C': 3.1862205593510162,  'D': 1.2378769285732698,  'E': 2.2909929753550826,  'F': -0.28258896805474465,  'G': -0.28258896805474465,  'H': -0.8778284727575083,  'I': 1.2378769285732698,  'K': -0.28258896805474465,  'L': -0.28258896805474465,  'M': -0.28258896805474465,  'N': -0.28258896805474465,  'P': 1.2378769285732698,  'Q': 1.2378769285732698,  'R': -0.28258896805474465,  'S': 1.2378769285732698,  'T': -0.28258896805474465,  'V': -0.28258896805474465,  'W': -1.4691207658906251,  'Y': -0.28258896805474465}, 'F': {'A': -0.28258896805474465,  'C': -0.28258896805474465,  'D': 0.6915828473341286,  'E': -0.28258896805474465,  'F': -0.28258896805474465,  'G': -0.28258896805474465,  'H': -0.28258896805474465,  'I': -0.28258896805474465,  'K': -1.4691207658906251,  'L': -0.28258896805474465,  'M': -0.28258896805474465,  'N': -0.28258896805474465,  'P': 1.2378769285732698,  'Q': -0.28258896805474465,  'R': -0.28258896805474465,  'S': -0.28258896805474465,  'T': -0.28258896805474465,  'V': -0.28258896805474465,  'W': -0.28258896805474465,  'Y': 2.2910719195864755}, 'G': {'A': -0.9528254925808008,  'C': -0.28258896805474465,  'D': -0.28258896805474465,  'E': -0.8778284727575083,  'F': -0.28258896805474465,  'G': 0.6915828473341286,  'H': -0.28258896805474465,  'I': -0.9528254925808008,  'K': -0.9528254925808008,  'L': -0.28258896805474465,  'M': -0.28258896805474465,  'N': -0.9528254925808008,  'P': -0.28258896805474465,  'Q': -0.28258896805474465,  'R': -0.28258896805474465,  'S': -0.28258896805474465,  'T': -0.9528254925808008,  'V': -0.28258896805474465,  'W': 0.6915828473341286,  'Y': -0.9528254925808008}, 'H': {'A': -0.28258896805474465,  'C': -0.28258896805474465,  'D': -0.28258896805474465,  'E': -0.28258896805474465,  'F': -1.1012406475995271,  'G': -1.1012406475995271,  'H': -0.28258896805474465,  'I': 3.1862205593510162,  'K': 1.5868104313300622,  'L': -0.28258896805474465,  'M': -0.28258896805474465,  'N': 1.5868104313300622,  'P': -0.5099483544664104,  'Q': -0.28258896805474465,  'R': -0.28258896805474465,  'S': -0.28258896805474465,  'T': -0.8778284727575083,  'V': -0.28258896805474465,  'W': -0.5099483544664104,  'Y': 3.1862205593510162}, 'I': {'A': -0.28258896805474465,  'C': -0.28258896805474465,  'D': -0.28258896805474465,  'E': 3.1862205593510162,  'F': -0.28258896805474465,  'G': -0.28258896805474465,  'H': 0.6915828473341286,  'I': -0.28258896805474465,  'K': -0.9528254925808008,  'L': 1.2378769285732698,  'M': -0.28258896805474465,  'N': -0.28258896805474465,  'P': -0.5099483544664104,  'Q': -0.28258896805474465,  'R': -0.28258896805474465,  'S': -0.28258896805474465,  'T': -0.28258896805474465,  'V': -0.9528254925808008,  'W': -0.28258896805474465,  'Y': -0.28258896805474465}, 'K': {'A': -0.28258896805474465,  'C': -0.28258896805474465,  'D': -0.28258896805474465,  'E': -0.28258896805474465,  'F': -0.28258896805474465,  'G': -0.9528254925808008,  'H': -0.28258896805474465,  'I': -0.9528254925808008,  'K': -0.28258896805474465,  'L': -0.9528254925808008,  'M': 2.2909929753550826,  'N': -0.28258896805474465,  'P': -0.8778284727575083,  'Q': 1.5836526620743447,  'R': 2.2909929753550826,  'S': -0.28258896805474465,  'T': -0.28258896805474465,  'V': -0.9528254925808008,  'W': -0.28258896805474465,  'Y': -0.28258896805474465}, 'L': {'A': -0.28258896805474465,  'C': -0.28258896805474465,  'D': -0.28258896805474465,  'E': -0.28258896805474465,  'F': -0.28258896805474465,  'G': -0.28258896805474465,  'H': -0.28258896805474465,  'I': -0.28258896805474465,  'K': -0.9528254925808008,  'L': -0.28258896805474465,  'M': -0.28258896805474465,  'N': -0.28258896805474465,  'P': 1.2378769285732698,  'Q': 2.2909929753550826,  'R': 1.2378769285732698,  'S': -0.28258896805474465,  'T': -0.28258896805474465,  'V': -0.28258896805474465,  'W': 1.5868104313300622,  'Y': -0.28258896805474465}, 'M': {'A': 0.6915828473341286,  'C': -0.28258896805474465,  'D': -0.28258896805474465,  'E': -0.28258896805474465,  'F': -0.28258896805474465,  'G': -0.28258896805474465,  'H': 4.239336606132829,  'I': -0.28258896805474465,  'K': -0.28258896805474465,  'L': -0.28258896805474465,  'M': -0.5099483544664104,  'N': -0.28258896805474465,  'P': 3.1862205593510162,  'Q': -0.8778284727575083,  'R': -0.8778284727575083,  'S': 3.1862205593510162,  'T': -0.5099483544664104,  'V': -0.28258896805474465,  'W': -0.28258896805474465,  'Y': 1.5868104313300622}, 'N': {'A': -0.28258896805474465,  'C': -0.5099483544664104,  'D': -0.28258896805474465,  'E': -0.28258896805474465,  'F': -1.4691207658906251,  'G': -1.4691207658906251,  'H': -0.28258896805474465,  'I': 3.1862205593510162,  'K': 1.5868104313300622,  'L': -0.28258896805474465,  'M': -0.28258896805474465,  'N': -0.28258896805474465,  'P': -0.5099483544664104,  'Q': -0.8778284727575083,  'R': -0.28258896805474465,  'S': -0.28258896805474465,  'T': -0.9528254925808008,  'V': -0.28258896805474465,  'W': -1.1012406475995271,  'Y': -0.28258896805474465}, 'P': {'A': 1.2378769285732698,  'C': -0.8778284727575083,  'D': -0.8778284727575083,  'E': 1.0894617735545435,  'F': 1.2378769285732698,  'G': -0.28258896805474465,  'H': -0.28258896805474465,  'I': -0.28258896805474465,  'K': -0.28258896805474465,  'L': -0.28258896805474465,  'M': -0.8778284727575083,  'N': -0.28258896805474465,  'P': 1.2378769285732698,  'Q': 1.2378769285732698,  'R': -0.8778284727575083,  'S': 1.2378769285732698,  'T': -0.28258896805474465,  'V': 1.2378769285732698,  'W': -0.5099483544664104,  'Y': -0.28258896805474465}, 'Q': {'A': -0.28258896805474465,  'C': -0.8778284727575083,  'D': 1.2378769285732698,  'E': 1.2378769285732698,  'F': -0.8778284727575083,  'G': -0.28258896805474465,  'H': -0.28258896805474465,  'I': -0.28258896805474465,  'K': -0.28258896805474465,  'L': -0.28258896805474465,  'M': -0.28258896805474465,  'N': -0.28258896805474465,  'P': 1.2378769285732698,  'Q': 1.2378769285732698,  'R': -0.28258896805474465,  'S': 3.1862205593510162,  'T': -0.28258896805474465,  'V': -0.8778284727575083,  'W': -0.28258896805474465,  'Y': -0.8778284727575083}, 'R': {'A': -0.28258896805474465,  'C': -0.28258896805474465,  'D': -0.28258896805474465,  'E': -0.28258896805474465,  'F': -0.28258896805474465,  'G': -0.9528254925808008,  'H': 1.2378769285732698,  'I': -0.28258896805474465,  'K': -0.28258896805474465,  'L': -0.28258896805474465,  'M': -0.28258896805474465,  'N': 0.6915828473341286,  'P': 1.2378769285732698,  'Q': 1.2378769285732698,  'R': 4.239336606132829,  'S': 3.1862205593510162,  'T': -0.28258896805474465,  'V': -0.28258896805474465,  'W': 4.239336606132829,  'Y': -0.8778284727575083}, 'S': {'A': -0.28258896805474465,  'C': 2.2909929753550826,  'D': -0.28258896805474465,  'E': 1.2378769285732698,  'F': -0.28258896805474465,  'G': -0.28258896805474465,  'H': -0.28258896805474465,  'I': -0.28258896805474465,  'K': -0.28258896805474465,  'L': -0.28258896805474465,  'M': -0.28258896805474465,  'N': -0.28258896805474465,  'P': 3.1862205593510162,  'Q': 1.2378769285732698,  'R': 1.2378769285732698,  'S': 1.2378769285732698,  'T': -0.28258896805474465,  'V': -0.28258896805474465,  'W': -0.28258896805474465,  'Y': -0.28258896805474465}, 'T': {'A': -0.28258896805474465,  'C': -0.28258896805474465,  'D': -0.28258896805474465,  'E': 1.2378769285732698,  'F': 0.6915828473341286,  'G': -0.9528254925808008,  'H': -0.28258896805474465,  'I': -0.28258896805474465,  'K': -0.28258896805474465,  'L': -0.28258896805474465,  'M': -0.28258896805474465,  'N': -1.4691207658906251,  'P': -0.28258896805474465,  'Q': -0.8778284727575083,  'R': -0.28258896805474465,  'S': -0.28258896805474465,  'T': -0.28258896805474465,  'V': -0.28258896805474465,  'W': -1.4691207658906251,  'Y': -0.28258896805474465}, 'V': {'A': -0.28258896805474465,  'C': -0.28258896805474465,  'D': -1.4691207658906251,  'E': -0.28258896805474465,  'F': -0.28258896805474465,  'G': -0.9528254925808008,  'H': -0.28258896805474465,  'I': -0.28258896805474465,  'K': -0.5099483544664104,  'L': -0.28258896805474465,  'M': -0.28258896805474465,  'N': -0.28258896805474465,  'P': 1.2378769285732698,  'Q': -0.28258896805474465,  'R': -0.28258896805474465,  'S': -0.28258896805474465,  'T': -0.9528254925808008,  'V': -0.28258896805474465,  'W': -0.28258896805474465,  'Y': -0.8778284727575083}, 'W': {'A': -1.4691207658906251,  'C': -0.28258896805474465,  'D': -0.28258896805474465,  'E': -0.28258896805474465,  'F': -0.28258896805474465,  'G': -1.1012406475995271,  'H': 1.5868104313300622,  'I': -0.28258896805474465,  'K': -0.28258896805474465,  'L': 0.6915828473341286,  'M': 1.5868104313300622,  'N': 0.6915828473341286,  'P': -0.28258896805474465,  'Q': -0.28258896805474465,  'R': -0.28258896805474465,  'S': -0.28258896805474465,  'T': -1.4691207658906251,  'V': -0.9528254925808008,  'W': -0.28258896805474465,  'Y': -0.28258896805474465}, 'Y': {'A': 1.5868104313300622,  'C': -0.28258896805474465,  'D': 1.5868104313300622,  'E': -0.8778284727575083,  'F': -0.28258896805474465,  'G': -0.9528254925808008,  'H': 0.6915828473341286,  'I': -0.28258896805474465,  'K': -0.28258896805474465,  'L': -0.28258896805474465,  'M': 3.1862205593510162,  'N': -0.28258896805474465,  'P': 0.6915828473341286,  'Q': -0.28258896805474465,  'R': -1.6175359209093514,  'S': -0.28258896805474465,  'T': -0.9528254925808008,  'V': -0.28258896805474465,  'W': -1.1012406475995271,  'Y': 0.6915828473341286}}


    trans_dict={'B':'DN', 'J':'LI', 'Z':'EQ', 'X':'ARNDCQEGHILKMFPSTWYV','U':'<EOS>','O':'<EOS>'}

    def __init__(self,sequence):

        self.seq=sequence

        self.prop=dict()

        # if the residues are ambiguous
        self.extended=False

        # check if there exist ambiguous residues
        for res,possible_res in ProtSeqProp.trans_dict.items():
            if res in sequence:
                self.extended=True

        if not self.extended:
            PA_analysis = ProteinAnalysis(sequence)
#            self.prop['secondary_structure_fraction']=PA_analysis.secondary_structure_fraction()
            self.prop['mean_molecular_weight']=((PA_analysis.molecular_weight()/len(self.seq))-136.90020499999997)/30.081960849078222
            self.prop['mean_surface_accessibility']= np.mean([ProtSeqProp.em[res] for res in list(sequence)])
            self.prop['mean_surface_accessibility']= np.mean([ProtSeqProp.em[res] for res in list(sequence)])
            self.prop['mean_kd_hydrophobicity']= np.mean([ProtSeqProp.kd[res] for res in list(sequence)])
            self.prop['mean_flexibility']= np.mean([ProtSeqProp.Flex[res] for res in list(sequence)])
            self.prop['mean_hydrophilicity']= np.mean([ProtSeqProp.hw[res] for res in list(sequence)])
            self.prop['mean_ja']= np.mean([ProtSeqProp.ja[res] for res in list(sequence)])
            alph_list=list(sequence)
            self.prop['instability']= np.mean([ProtSeqProp.DIWV[x][y] for x,y in zip(alph_list[:-1], alph_list[1:])])
